---
slug: "node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°"
title: "Node å®šæ—¶å™¨è¯¦è§£ - é˜®ä¸€å³°"
main_category: Frontend
category: 3. JavaScript
tags: [""]
status: âœ… Completed
author: scott scott
created_time: 2021-03-28
updated_time: 2021-03-28
---

<br />

<br />

<br />

JavaScript æ˜¯å•çº¿ç¨‹è¿è¡Œï¼Œå¼‚æ­¥æ“ä½œç‰¹åˆ«é‡è¦ã€‚

åªè¦ç”¨åˆ°å¼•æ“ä¹‹å¤–çš„åŠŸèƒ½ï¼Œå°±éœ€è¦è·Ÿå¤–éƒ¨äº¤äº’ï¼Œä»è€Œå½¢æˆå¼‚æ­¥æ“ä½œã€‚ç”±äºå¼‚æ­¥æ“ä½œå®åœ¨å¤ªå¤šï¼ŒJavaScript ä¸å¾—ä¸æä¾›å¾ˆå¤šå¼‚æ­¥è¯­æ³•ã€‚è¿™å°±å¥½æ¯”ï¼Œæœ‰äº›äººè€æ˜¯å—æ‰“å‡»ï¼Œ ä»–çš„æŠ—æ‰“å‡»èƒ½åŠ›å¿…é¡»å˜å¾—å¾ˆå¼ºï¼Œå¦åˆ™ä»–å°±å®Œè›‹äº†ã€‚

Node çš„å¼‚æ­¥è¯­æ³•æ¯”æµè§ˆå™¨æ›´å¤æ‚ï¼Œå› ä¸ºå®ƒå¯ä»¥è·Ÿå†…æ ¸å¯¹è¯ï¼Œä¸å¾—ä¸æäº†ä¸€ä¸ªä¸“é—¨çš„åº“ [libuv](http://thlorenz.com/learnuv/book/history/history_1.html) åšè¿™ä»¶äº‹ã€‚è¿™ä¸ªåº“è´Ÿè´£å„ç§å›è°ƒå‡½æ•°çš„æ‰§è¡Œæ—¶é—´ï¼Œæ¯•ç«Ÿå¼‚æ­¥ä»»åŠ¡æœ€åè¿˜æ˜¯è¦å›åˆ°ä¸»çº¿ç¨‹ï¼Œä¸€ä¸ªä¸ªæ’é˜Ÿæ‰§è¡Œã€‚

![2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-0](./images/2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-0.jpg)

ä¸ºäº†åè°ƒå¼‚æ­¥ä»»åŠ¡ï¼ŒNode å±…ç„¶æä¾›äº†å››ä¸ªå®šæ—¶å™¨ï¼Œè®©ä»»åŠ¡å¯ä»¥åœ¨æŒ‡å®šçš„æ—¶é—´è¿è¡Œã€‚

> setTimeout() setInterval() setImmediate() process.nextTick()

**å‰ä¸¤ä¸ªæ˜¯è¯­è¨€çš„æ ‡å‡†ï¼Œåä¸¤ä¸ªæ˜¯ Node ç‹¬æœ‰çš„**ã€‚å®ƒä»¬çš„å†™æ³•å·®ä¸å¤šï¼Œä½œç”¨ä¹Ÿå·®ä¸å¤šï¼Œä¸å¤ªå®¹æ˜“åŒºåˆ«ã€‚

ä½ èƒ½è¯´å‡ºä¸‹é¢ä»£ç çš„è¿è¡Œç»“æœå—ï¼Ÿ

<br />

```javascript
(() => console.log(5))();
process.nextTick(() => console.log(3));
Promise.resolve().then(() => console.log(4));
setTimeout(() => console.log(1));
setImmediate(() => console.log(2));
```

è¿è¡Œç»“æœå¦‚ä¸‹ã€‚

$ node test.js
5
3
4
1
2

å¦‚æœä½ èƒ½ä¸€å£è¯´å¯¹ï¼Œå¯èƒ½å°±ä¸éœ€è¦å†çœ‹ä¸‹å»äº†ã€‚æœ¬æ–‡è¯¦ç»†è§£é‡Šï¼ŒNode æ€ä¹ˆå¤„ç†å„ç§å®šæ—¶å™¨ï¼Œæˆ–è€…æ›´å¹¿ä¹‰åœ°è¯´ï¼Œlibuv åº“æ€ä¹ˆå®‰æ’å¼‚æ­¥ä»»åŠ¡åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚

### ä¸€ã€åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡

é¦–å…ˆï¼ŒåŒæ­¥ä»»åŠ¡æ€»æ˜¯æ¯”å¼‚æ­¥ä»»åŠ¡æ›´æ—©æ‰§è¡Œã€‚

å‰é¢çš„é‚£æ®µä»£ç ï¼Œåªæœ‰æœ€åä¸€è¡Œæ˜¯åŒæ­¥ä»»åŠ¡ï¼Œå› æ­¤æœ€æ—©æ‰§è¡Œã€‚

### äºŒã€æœ¬è½®å¾ªç¯å’Œæ¬¡è½®å¾ªç¯

å¼‚æ­¥ä»»åŠ¡å¯ä»¥åˆ†æˆä¸¤ç§ã€‚

> è¿½åŠ åœ¨æœ¬è½®å¾ªç¯çš„å¼‚æ­¥ä»»åŠ¡ è¿½åŠ åœ¨æ¬¡è½®å¾ªç¯çš„å¼‚æ­¥ä»»åŠ¡

æ‰€è°“"å¾ªç¯"ï¼ŒæŒ‡çš„æ˜¯äº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰ã€‚è¿™æ˜¯ JavaScript å¼•æ“å¤„ç†å¼‚æ­¥ä»»åŠ¡çš„æ–¹å¼ï¼Œåæ–‡ä¼šè¯¦ç»†è§£é‡Šã€‚è¿™é‡Œåªè¦ç†è§£ï¼Œæœ¬è½®å¾ªç¯ä¸€å®šæ—©äºæ¬¡è½®å¾ªç¯æ‰§è¡Œå³å¯ã€‚

<br />

> ğŸ’¡ Node è§„å®šï¼Œ`process.nextTick`å’Œ`Promise`çš„å›è°ƒå‡½æ•°ï¼Œè¿½åŠ åœ¨æœ¬è½®å¾ªç¯ï¼Œå³åŒæ­¥ä»»åŠ¡ä¸€æ—¦æ‰§è¡Œå®Œæˆï¼Œå°±å¼€å§‹æ‰§è¡Œå®ƒä»¬ã€‚

<br />

> ğŸ’¡ è€Œ`setTimeout`ã€`setInterval`ã€`setImmediate`çš„å›è°ƒå‡½æ•°ï¼Œè¿½åŠ åœ¨æ¬¡è½®å¾ªç¯ã€‚

<br />

è¿™å°±æ˜¯è¯´ï¼Œæ–‡é¦–é‚£æ®µä»£ç çš„ç¬¬ä¸‰è¡Œå’Œç¬¬å››è¡Œï¼Œä¸€å®šæ¯”ç¬¬ä¸€è¡Œå’Œç¬¬äºŒè¡Œæ›´æ—©æ‰§è¡Œã€‚

> // ä¸‹é¢ä¸¤è¡Œï¼Œæ¬¡è½®å¾ªç¯æ‰§è¡Œ
> setTimeout(() => console.log(1));
> setImmediate(() => console.log(2));
> // ä¸‹é¢ä¸¤è¡Œï¼Œæœ¬è½®å¾ªç¯æ‰§è¡Œ
> process.nextTick(() => console.log(3));
> Promise.resolve().then(() => console.log(4));

### ä¸‰ã€process.nextTick()

`process.nextTick`è¿™ä¸ªåå­—æœ‰ç‚¹è¯¯å¯¼ï¼Œå®ƒæ˜¯åœ¨æœ¬è½®å¾ªç¯æ‰§è¡Œçš„ï¼Œè€Œä¸”æ˜¯**æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡é‡Œé¢æœ€å¿«æ‰§è¡Œçš„ã€‚**

![2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-1](./images/2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-1.png)

**Node æ‰§è¡Œå®Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡ï¼Œæ¥ä¸‹æ¥å°±ä¼šæ‰§è¡Œ\*\***`process.nextTick`\*\* **çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚**æ‰€ä»¥ï¼Œä¸‹é¢è¿™è¡Œä»£ç æ˜¯ç¬¬äºŒä¸ªè¾“å‡ºç»“æœã€‚

åŸºæœ¬ä¸Šï¼Œå¦‚æœä½ å¸Œæœ›å¼‚æ­¥ä»»åŠ¡å°½å¯èƒ½å¿«åœ°æ‰§è¡Œï¼Œé‚£å°±ä½¿ç”¨`process.nextTick`ã€‚

### å››ã€å¾®ä»»åŠ¡

æ ¹æ®è¯­è¨€è§„æ ¼ï¼Œ`Promise`å¯¹è±¡çš„å›è°ƒå‡½æ•°ï¼Œä¼šè¿›å…¥å¼‚æ­¥ä»»åŠ¡é‡Œé¢çš„"å¾®ä»»åŠ¡"ï¼ˆmicrotaskï¼‰é˜Ÿåˆ—ã€‚

å¾®ä»»åŠ¡é˜Ÿåˆ—è¿½åŠ åœ¨`process.nextTick`é˜Ÿåˆ—çš„åé¢ï¼Œä¹Ÿå±äºæœ¬è½®å¾ªç¯ã€‚æ‰€ä»¥ï¼Œä¸‹é¢çš„ä»£ç æ€»æ˜¯å…ˆè¾“å‡º`3`ï¼Œå†è¾“å‡º`4`ã€‚

> process.nextTick(() => console.log(3));
> Promise.resolve().then(() => console.log(4));
> // 3
> // 4

![2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-2](./images/2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-2.png)

æ³¨æ„ï¼Œåªæœ‰å‰ä¸€ä¸ªé˜Ÿåˆ—å…¨éƒ¨æ¸…ç©ºä»¥åï¼Œæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—ã€‚

> process.nextTick(() => console.log(1));
> Promise.resolve().then(() => console.log(2));
> process.nextTick(() => console.log(3));
> Promise.resolve().then(() => console.log(4));
> // 1
> // 3
> // 2
> // 4

ä¸Šé¢ä»£ç ä¸­ï¼Œå…¨éƒ¨`process.nextTick`çš„å›è°ƒå‡½æ•°ï¼Œæ‰§è¡Œéƒ½ä¼šæ—©äº`Promise`çš„ã€‚

è‡³æ­¤ï¼Œæœ¬è½®å¾ªç¯çš„æ‰§è¡Œé¡ºåºå°±è®²å®Œäº†ã€‚

> åŒæ­¥ä»»åŠ¡ process.nextTick() å¾®ä»»åŠ¡

### äº”ã€äº‹ä»¶å¾ªç¯çš„æ¦‚å¿µ

ä¸‹é¢å¼€å§‹ä»‹ç»æ¬¡è½®å¾ªç¯çš„æ‰§è¡Œé¡ºåºï¼Œè¿™å°±å¿…é¡»ç†è§£ä»€ä¹ˆæ˜¯äº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰äº†ã€‚

Node çš„[å®˜æ–¹æ–‡æ¡£](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)æ˜¯è¿™æ ·ä»‹ç»çš„ã€‚

> "When Node.js starts, it initializes the event loop, processes the provided input script which may make async API calls, schedule timers, or call process.nextTick(), then begins processing the event loop."

è¿™æ®µè¯å¾ˆé‡è¦ï¼Œéœ€è¦ä»”ç»†è¯»ã€‚å®ƒè¡¨è¾¾äº†ä¸‰å±‚æ„æ€ã€‚

é¦–å…ˆï¼Œæœ‰äº›äººä»¥ä¸ºï¼Œé™¤äº†ä¸»çº¿ç¨‹ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªå•ç‹¬çš„äº‹ä»¶å¾ªç¯çº¿ç¨‹ã€‚ä¸æ˜¯è¿™æ ·çš„ï¼Œåªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œäº‹ä»¶å¾ªç¯æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šå®Œæˆçš„ã€‚

å…¶æ¬¡ï¼ŒNode å¼€å§‹æ‰§è¡Œè„šæœ¬æ—¶ï¼Œä¼šå…ˆè¿›è¡Œäº‹ä»¶å¾ªç¯çš„åˆå§‹åŒ–ï¼Œä½†æ˜¯è¿™æ—¶äº‹ä»¶å¾ªç¯è¿˜æ²¡æœ‰å¼€å§‹ï¼Œä¼šå…ˆå®Œæˆä¸‹é¢çš„äº‹æƒ…ã€‚

> åŒæ­¥ä»»åŠ¡ å‘å‡ºå¼‚æ­¥è¯·æ±‚ è§„åˆ’å®šæ—¶å™¨ç”Ÿæ•ˆçš„æ—¶é—´ æ‰§è¡Œ process.nextTick()ç­‰ç­‰

æœ€åï¼Œä¸Šé¢è¿™äº›äº‹æƒ…éƒ½å¹²å®Œäº†ï¼Œäº‹ä»¶å¾ªç¯å°±æ­£å¼å¼€å§‹äº†ã€‚

### å…­ã€äº‹ä»¶å¾ªç¯çš„å…­ä¸ªé˜¶æ®µ

äº‹ä»¶å¾ªç¯ä¼šæ— é™æ¬¡åœ°æ‰§è¡Œï¼Œä¸€è½®åˆä¸€è½®ã€‚åªæœ‰å¼‚æ­¥ä»»åŠ¡çš„å›è°ƒå‡½æ•°é˜Ÿåˆ—æ¸…ç©ºäº†ï¼Œæ‰ä¼šåœæ­¢æ‰§è¡Œã€‚

æ¯ä¸€è½®çš„äº‹ä»¶å¾ªç¯ï¼Œåˆ†æˆå…­ä¸ªé˜¶æ®µã€‚è¿™äº›é˜¶æ®µä¼šä¾æ¬¡æ‰§è¡Œã€‚

> timers I/O callbacks idle, prepare poll check close callbacks

æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„å›è°ƒå‡½æ•°é˜Ÿåˆ—ã€‚åªæœ‰ä¸€ä¸ªé˜¶æ®µçš„å›è°ƒå‡½æ•°é˜Ÿåˆ—æ¸…ç©ºäº†ï¼Œè¯¥æ‰§è¡Œçš„å›è°ƒå‡½æ•°éƒ½æ‰§è¡Œäº†ï¼Œäº‹ä»¶å¾ªç¯æ‰ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚

![2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-3](./images/2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-3.png)

ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹æ¯ä¸ªé˜¶æ®µçš„å«ä¹‰ï¼Œè¯¦ç»†ä»‹ç»å¯ä»¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ libuv çš„[æºç è§£è¯»](https://jsblog.insiderattack.net/handling-io-nodejs-event-loop-part-4-418062f917d1)ã€‚

**ï¼ˆ1ï¼‰timers**

è¿™ä¸ªæ˜¯å®šæ—¶å™¨é˜¶æ®µï¼Œå¤„ç†`setTimeout()`å’Œ`setInterval()`çš„å›è°ƒå‡½æ•°ã€‚è¿›å…¥è¿™ä¸ªé˜¶æ®µåï¼Œä¸»çº¿ç¨‹ä¼šæ£€æŸ¥ä¸€ä¸‹å½“å‰æ—¶é—´ï¼Œæ˜¯å¦æ»¡è¶³å®šæ—¶å™¨çš„æ¡ä»¶ã€‚å¦‚æœæ»¡è¶³å°±æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå¦åˆ™å°±ç¦»å¼€è¿™ä¸ªé˜¶æ®µã€‚

**ï¼ˆ2ï¼‰I/O callbacks**

é™¤äº†ä»¥ä¸‹æ“ä½œçš„å›è°ƒå‡½æ•°ï¼Œå…¶ä»–çš„å›è°ƒå‡½æ•°éƒ½åœ¨è¿™ä¸ªé˜¶æ®µæ‰§è¡Œã€‚

> setTimeout()å’Œ setInterval()çš„å›è°ƒå‡½æ•° setImmediate()çš„å›è°ƒå‡½æ•° ç”¨äºå…³é—­è¯·æ±‚çš„å›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚ socket.on('close', ...)

**ï¼ˆ3ï¼‰idle, prepare**

è¯¥é˜¶æ®µåªä¾› libuv å†…éƒ¨è°ƒç”¨ï¼Œè¿™é‡Œå¯ä»¥å¿½ç•¥ã€‚

**ï¼ˆ4ï¼‰Poll**

è¿™ä¸ªé˜¶æ®µæ˜¯è½®è¯¢æ—¶é—´ï¼Œç”¨äºç­‰å¾…è¿˜æœªè¿”å›çš„ I/O äº‹ä»¶ï¼Œæ¯”å¦‚æœåŠ¡å™¨çš„å›åº”ã€ç”¨æˆ·ç§»åŠ¨é¼ æ ‡ç­‰ç­‰ã€‚

è¿™ä¸ªé˜¶æ®µçš„æ—¶é—´ä¼šæ¯”è¾ƒé•¿ã€‚å¦‚æœæ²¡æœ‰å…¶ä»–å¼‚æ­¥ä»»åŠ¡è¦å¤„ç†ï¼ˆæ¯”å¦‚åˆ°æœŸçš„å®šæ—¶å™¨ï¼‰ï¼Œä¼šä¸€ç›´åœç•™åœ¨è¿™ä¸ªé˜¶æ®µï¼Œç­‰å¾… I/O è¯·æ±‚è¿”å›ç»“æœã€‚

**ï¼ˆ5ï¼‰check**

è¯¥é˜¶æ®µæ‰§è¡Œ`setImmediate()`çš„å›è°ƒå‡½æ•°ã€‚

**ï¼ˆ6ï¼‰close callbacks**

è¯¥é˜¶æ®µæ‰§è¡Œå…³é—­è¯·æ±‚çš„å›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚`socket.on('close', ...)`ã€‚

### ä¸ƒã€äº‹ä»¶å¾ªç¯çš„ç¤ºä¾‹

ä¸‹é¢æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„ä¸€ä¸ªç¤ºä¾‹ã€‚

> const fs = require('fs');

const timeoutScheduled = Date.now();

// å¼‚æ­¥ä»»åŠ¡ä¸€ï¼š100ms åæ‰§è¡Œçš„å®šæ—¶å™¨
setTimeout(() => {
const delay = Date.now() - timeoutScheduled;
console.log(`${delay}ms`);
}, 100);

// å¼‚æ­¥ä»»åŠ¡äºŒï¼šæ–‡ä»¶è¯»å–åï¼Œæœ‰ä¸€ä¸ª 200ms çš„å›è°ƒå‡½æ•°
fs.readFile('test.js', () => {
const startCallback = Date.now();
while (Date.now() - startCallback < 200) {
// ä»€ä¹ˆä¹Ÿä¸åš
}
});

ä¸Šé¢ä»£ç æœ‰ä¸¤ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œä¸€ä¸ªæ˜¯ 100ms åæ‰§è¡Œçš„å®šæ—¶å™¨ï¼Œä¸€ä¸ªæ˜¯æ–‡ä»¶è¯»å–ï¼Œå®ƒçš„å›è°ƒå‡½æ•°éœ€è¦ 200msã€‚è¯·é—®è¿è¡Œç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ

![2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-4](./images/2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-4.jpg)

è„šæœ¬è¿›å…¥ç¬¬ä¸€è½®äº‹ä»¶å¾ªç¯ä»¥åï¼Œæ²¡æœ‰åˆ°æœŸçš„å®šæ—¶å™¨ï¼Œä¹Ÿæ²¡æœ‰å·²ç»å¯ä»¥æ‰§è¡Œçš„ I/O å›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ Poll é˜¶æ®µï¼Œç­‰å¾…å†…æ ¸è¿”å›æ–‡ä»¶è¯»å–çš„ç»“æœã€‚ç”±äºè¯»å–å°æ–‡ä»¶ä¸€èˆ¬ä¸ä¼šè¶…è¿‡ 100msï¼Œæ‰€ä»¥åœ¨å®šæ—¶å™¨åˆ°æœŸä¹‹å‰ï¼ŒPoll é˜¶æ®µå°±ä¼šå¾—åˆ°ç»“æœï¼Œå› æ­¤å°±ä¼šç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚

ç¬¬äºŒè½®äº‹ä»¶å¾ªç¯ï¼Œä¾ç„¶æ²¡æœ‰åˆ°æœŸçš„å®šæ—¶å™¨ï¼Œä½†æ˜¯å·²ç»æœ‰äº†å¯ä»¥æ‰§è¡Œçš„ I/O å›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ I/O callbacks é˜¶æ®µï¼Œæ‰§è¡Œ`fs.readFile`çš„å›è°ƒå‡½æ•°ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°éœ€è¦ 200msï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®ƒæ‰§è¡Œåˆ°ä¸€åŠçš„æ—¶å€™ï¼Œ100ms çš„å®šæ—¶å™¨å°±ä¼šåˆ°æœŸã€‚ä½†æ˜¯ï¼Œå¿…é¡»ç­‰åˆ°è¿™ä¸ªå›è°ƒå‡½æ•°æ‰§è¡Œå®Œï¼Œæ‰ä¼šç¦»å¼€è¿™ä¸ªé˜¶æ®µã€‚

ç¬¬ä¸‰è½®äº‹ä»¶å¾ªç¯ï¼Œå·²ç»æœ‰äº†åˆ°æœŸçš„å®šæ—¶å™¨ï¼Œæ‰€ä»¥ä¼šåœ¨ timers é˜¶æ®µæ‰§è¡Œå®šæ—¶å™¨ã€‚æœ€åè¾“å‡ºç»“æœå¤§æ¦‚æ˜¯ 200 å¤šæ¯«ç§’ã€‚

### å…«ã€setTimeout å’Œ setImmediate

ç”±äº`setTimeout`åœ¨ timers é˜¶æ®µæ‰§è¡Œï¼Œè€Œ`setImmediate`åœ¨ check é˜¶æ®µæ‰§è¡Œã€‚æ‰€ä»¥ï¼Œ`setTimeout`ä¼šæ—©äº`setImmediate`å®Œæˆã€‚

ä¸Šé¢ä»£ç åº”è¯¥å…ˆè¾“å‡º`1`ï¼Œå†è¾“å‡º`2`ï¼Œä½†æ˜¯å®é™…æ‰§è¡Œçš„æ—¶å€™ï¼Œç»“æœå´æ˜¯ä¸ç¡®å®šï¼Œæœ‰æ—¶è¿˜ä¼šå…ˆè¾“å‡º`2`ï¼Œå†è¾“å‡º`1`ã€‚

è¿™æ˜¯å› ä¸º`setTimeout`çš„ç¬¬äºŒä¸ªå‚æ•°é»˜è®¤ä¸º`0`ã€‚ä½†æ˜¯å®é™…ä¸Šï¼ŒNode åšä¸åˆ° 0 æ¯«ç§’ï¼Œæœ€å°‘ä¹Ÿéœ€è¦ 1 æ¯«ç§’ï¼Œæ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://nodejs.org/api/timers.html#timers_settimeout_callback_delay_args)ï¼Œç¬¬äºŒä¸ªå‚æ•°çš„å–å€¼èŒƒå›´åœ¨ 1 æ¯«ç§’åˆ° 2147483647 æ¯«ç§’ä¹‹é—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`setTimeout(f, 0)`ç­‰åŒäº`setTimeout(f, 1)`ã€‚

å®é™…æ‰§è¡Œçš„æ—¶å€™ï¼Œè¿›å…¥äº‹ä»¶å¾ªç¯ä»¥åï¼Œæœ‰å¯èƒ½åˆ°äº† 1 æ¯«ç§’ï¼Œä¹Ÿå¯èƒ½è¿˜æ²¡åˆ° 1 æ¯«ç§’ï¼Œå–å†³äºç³»ç»Ÿå½“æ—¶çš„çŠ¶å†µã€‚å¦‚æœæ²¡åˆ° 1 æ¯«ç§’ï¼Œé‚£ä¹ˆ timers é˜¶æ®µå°±ä¼šè·³è¿‡ï¼Œè¿›å…¥ check é˜¶æ®µï¼Œå…ˆæ‰§è¡Œ`setImmediate`çš„å›è°ƒå‡½æ•°ã€‚

ä½†æ˜¯ï¼Œä¸‹é¢çš„ä»£ç ä¸€å®šæ˜¯å…ˆè¾“å‡º 2ï¼Œå†è¾“å‡º 1ã€‚

> const fs = require('fs');

fs.readFile('test.js', () => {
setTimeout(() => console.log(1));
setImmediate(() => console.log(2));
});

ä¸Šé¢ä»£ç ä¼šå…ˆè¿›å…¥ I/O callbacks é˜¶æ®µï¼Œç„¶åæ˜¯ check é˜¶æ®µï¼Œæœ€åæ‰æ˜¯ timers é˜¶æ®µã€‚å› æ­¤ï¼Œ`setImmediate`æ‰ä¼šæ—©äº`setTimeout`æ‰§è¡Œã€‚

### ä¹ã€å‚è€ƒé“¾æ¥

ï¼ˆå®Œï¼‰

[ç®—æ³•è®­ç»ƒè¥ä½“éªŒè¯¾](https://u.geekbang.org/subject/prioralgorithm?gk_liebian=false&cus_user_wechat=university&utm_source=ruanyifeng&utm_medium=1010&utm_term=kolruanyifeng1118)

![2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-5](./images/2021-03-28-node-å®šæ—¶å™¨è¯¦è§£-é˜®ä¸€å³°-image-5.jpg)

### ç›¸å…³æ–‡ç« 

[https://www.notion.so/wooodhead/73170919728f46f5b985cd6b29ede984?v=7c3cd82afa824904826be95edd7d9578&p=b5fd3d24192846ef9eabcf85d87542d0](https://www.notion.so/wooodhead/73170919728f46f5b985cd6b29ede984?v=7c3cd82afa824904826be95edd7d9578&p=b5fd3d24192846ef9eabcf85d87542d0)
